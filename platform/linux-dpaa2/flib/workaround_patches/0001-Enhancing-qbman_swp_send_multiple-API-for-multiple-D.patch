From 372b5b7ed6ee666b636a48f023401c225ede25da Mon Sep 17 00:00:00 2001
From: Sunil Kumar Kori <Sunil.Kori@nxp.com>
Date: Wed, 26 Apr 2017 16:32:50 +0530
Subject: [PATCH] Enhancing qbman_swp_send_multiple API for multiple DCAs

Signed-off-by: Sunil Kumar Kori <Sunil.Kori@nxp.com>
ODP-989
---
 driver/qbman_portal.c              | 10 ++++++++--
 include/drivers/fsl_qbman_portal.h |  7 ++++++-
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/driver/qbman_portal.c b/driver/qbman_portal.c
index 6de7bd0..72ab577 100644
--- a/driver/qbman_portal.c
+++ b/driver/qbman_portal.c
@@ -1295,13 +1295,16 @@ int qbman_swp_send_multiple(struct qbman_swp *s,
                p = qbman_cena_write_start_wo_shadow_fast(&s->sys,
                                                          QBMAN_CENA_SWP_EQCR((initial_pi) & 7));
                /* Write command (except of first byte) and FD */
-               memcpy(&p[1], &cl[1], 7 * 4);
+		memcpy(&p[1], &cl[1], 7 * 4);
                memcpy(&p[8], &fd[sent], sizeof(struct qbman_fd));
 
                initial_pi++;
                initial_pi &= 0xF;
                s->eqcr.available--;
                sent++;
+		/*Pointing to the next enqueue descriptor*/
+		cl += (sizeof(struct qbman_eq_desc) / sizeof(uint32_t));
+
        }
 
 done:
@@ -1312,16 +1315,19 @@ done:
        /*For that we use a following trick: we record all lines in 32 bit word */
 
        initial_pi =  s->eqcr.pi;
+	cl = qb_cl(d);
        for (i = 0; i < sent; i++) {
                p = qbman_cena_write_start_wo_shadow_fast(&s->sys,
                                                          QBMAN_CENA_SWP_EQCR((initial_pi) & 7));
 
-               p[0] = cl[0] | s->eqcr.pi_vb;
+		p[0] = cl[0] | s->eqcr.pi_vb;
                initial_pi++;
                initial_pi &= 0xF;
 
                if (!(initial_pi & 7))
                        s->eqcr.pi_vb ^= QB_VALID_BIT;
+		/*Pointing to the next enqueue descriptor*/
+		cl += (sizeof(struct qbman_eq_desc) / sizeof(uint32_t));
        }
 
        initial_pi = s->eqcr.pi;
diff --git a/include/drivers/fsl_qbman_portal.h b/include/drivers/fsl_qbman_portal.h
index 6fc85b7..435887d 100644
--- a/include/drivers/fsl_qbman_portal.h
+++ b/include/drivers/fsl_qbman_portal.h
@@ -1103,7 +1103,12 @@ int qbman_swp_CDAN_disable(struct qbman_swp *s, uint16_t channelid);
  */
 int qbman_swp_CDAN_set_context_enable(struct qbman_swp *s, uint16_t channelid,
 				      uint64_t ctx);
-
+/**
+ * @s: the software portal object.
+ * @d: Array of enqueue descriptors.
+ * @fd: Array of FDs to be enqueued.
+ * @frames_to_send: Number of FDs to be enqueued.
+*/
 int qbman_swp_send_multiple(struct qbman_swp *s,
                            const struct qbman_eq_desc *d,
                            const struct qbman_fd *fd,
-- 
1.9.1

